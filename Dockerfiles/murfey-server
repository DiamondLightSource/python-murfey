# Template build command
# podman build --build-arg groupid=<groupid> --build-arg userid=<userid> --build-arg groupname=<groupname> --no-cache -f path/to/Dockerfiles/murfey-server -t murfey-server:<version> path/to/python-murfey

# Set up the base image to build with
FROM docker.io/library/python:3.12.8-slim-bullseye AS base

# Install Vim in base image
RUN apt-get update && \
    apt-get upgrade -y && \
    apt-get install -y --no-install-recommends \
        vim \
        && \
    apt-get autoremove && \
    rm -rf /var/lib/apt/lists/*


# Build Murfey in a separate image
FROM base as build
COPY ./ /python-murfey/
RUN apt-get update && \
    apt-get upgrade -y && \
    apt-get install -y --no-install-recommends \
        build-essential \
        busybox \
        git \
        libpq-dev \
        net-tools \
        && \
    busybox --install && \
    python -m venv /venv && \
    /venv/bin/python -m pip install --upgrade \
        pip \
        build \
        importlib-metadata \
        psycopg2-binary \
        && \
    /venv/bin/python -m pip install /python-murfey[server]


# Transfer completed Murfey build to a clean image
FROM base

# Define external build arguments
ARG groupid
ARG groupname
ARG userid

# Copy completed Murfey build across, install Vim, and set user and group permissions
COPY --from=build /venv/ /venv/
RUN groupadd -r -g "${groupid}" "${groupname}" && \
    useradd -r -M "${groupname}" -u "${userid}" -g "${groupname}" && \
    chown -R "${userid}":"${groupid}" /venv && \
    chmod -R a+x /venv
ENV PATH=/venv/bin:$PATH
USER "${userid}":"${groupid}"
